<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grace Radio - Live Broadcast</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">

    <!-- PWA / Mobile Capable -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1f1f1f">
</head>

<body>

    <div class="app-container">
        <!-- Sidebar / Navigation -->
        <nav class="sidebar">
            <div class="brand">
                <h1>Grace Radio</h1>
                <div class="live-indicator">
                    <span class="dot"></span> LIVE
                </div>
                {% if is_admin %}
                <div id="listener-stats" style="margin-top:5px; font-size:0.8rem; opacity:0.7;">
                    ðŸ‘‚ <span id="listener-count">0</span>
                </div>
                {% endif %}
            </div>

            <div class="menu">
                <button class="menu-btn active" onclick="switchTab('player-view')">Now Playing</button>
                <button class="menu-btn" onclick="switchTab('library-view')">Media Library</button>
                <button class="menu-btn" onclick="switchTab('schedule-view')">Schedule</button>
                {% if is_admin %}
                <button class="menu-btn" onclick="switchTab('stats-view')">Statistics</button>
                {% endif %}
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="content">

            <!-- VIEW: PLAYER (Home) -->
            <div id="player-view" class="view active">
                <div class="player-hero">
                    <div class="album-art-placeholder" id="current-art">
                        <span id="art-initials">â™«</span>
                    </div>
                    <div class="track-info">
                        <h2 id="current-title">Waiting for broadcast...</h2>
                        <p id="current-category" class="category-badge">Offline</p>

                        <!-- Star Rating -->
                        <div class="star-rating-container" id="vote-controls">
                            <!-- Stars are reversed in CSS for hover effects commonly -->
                            <div class="stars">
                                <span class="star" onclick="sendVote(5)" data-value="5">â˜…</span>
                                <span class="star" onclick="sendVote(4)" data-value="4">â˜…</span>
                                <span class="star" onclick="sendVote(3)" data-value="3">â˜…</span>
                                <span class="star" onclick="sendVote(2)" data-value="2">â˜…</span>
                                <span class="star" onclick="sendVote(1)" data-value="1">â˜…</span>
                            </div>
                            <p class="vote-feedback" id="vote-msg">Rate this track</p>
                        </div>

                        <div class="progress-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="time-info">
                            <span id="current-time">0:00</span>
                            <span id="total-time">0:00</span>
                        </div>
                    </div>
                </div>

                <div class="up-next-section">
                    <h3>Up Next</h3>
                    <div class="queue-list" id="active-queue">
                        <!-- Queue items injected here -->
                        <p class="empty-state">Queue is empty. Shuffling playlist.</p>
                    </div>
                </div>

                <!-- Hidden Audio Elements -->
                <audio id="radio-audio" crossorigin="anonymous" preload="auto"></audio>
                <audio id="radio-audio-2" crossorigin="anonymous" preload="auto"></audio>

                <div class="controls">
                    <!-- ... -->
                    <button class="control-btn" id="mute-btn" onclick="toggleMute()">Mute</button>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1"
                        onchange="setVolume(this.value)">
                    <button class="control-btn primary" id="sync-btn" onclick="togglePlayStop()"
                        title="Start/Stop Playback">â–¶ Play</button>
                    {% if is_admin %}
                    <br>
                    <div class="admin-toolbar"
                        style="margin-top:10px; display:flex; gap:10px; align-items:center; background:#333; padding:5px; border-radius:5px;">
                        <span style="font-size:0.8rem; color:#aaa;">Crossfade:</span>
                        <input type="range" min="0" max="10" step="0.5" value="3" oninput="updateCrossfade(this.value)"
                            style="width:100px;">
                        <span id="cf-val" style="font-size:0.8rem;">3s</span>
                        <div style="width:1px; height:20px; background:#555; margin:0 5px;"></div>
                        <button class="control-btn" onclick="openEQModal()">EQ</button>
                        <button class="control-btn" onclick="skipTrack()">Skip</button>
                        <button class="control-btn" onclick="openYoutubeModal()">YT Import</button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ... -->
            <!-- MODAL: EQ -->
            <div id="eq-modal" class="modal">
                <div class="modal-content" style="max-width:400px;">
                    <span class="close" onclick="closeEQModal()">&times;</span>
                    <h2>Track Equalizer</h2>
                    <div style="display:flex; justify-content:space-around; padding:20px;">
                        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                            <label>Low</label>
                            <input type="range" id="eq-low" min="-10" max="10" step="1" value="0" orient="vertical"
                                style="appearance: slider-vertical; height:150px; width:20px;">
                            <span style="font-size:0.9em;"><span id="val-low">0</span>dB</span>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                            <label>Mid</label>
                            <input type="range" id="eq-mid" min="-10" max="10" step="1" value="0" orient="vertical"
                                style="appearance: slider-vertical; height:150px; width:20px;">
                            <span style="font-size:0.9em;"><span id="val-mid">0</span>dB</span>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                            <label>High</label>
                            <input type="range" id="eq-high" min="-10" max="10" step="1" value="0" orient="vertical"
                                style="appearance: slider-vertical; height:150px; width:20px;">
                            <span style="font-size:0.9em;"><span id="val-high">0</span>dB</span>
                        </div>
                    </div>
                    <button onclick="saveEQ()" class="btn-primary" style="width:100%">Save to Track</button>
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div id="library-view" class="view">
                <div class="view-header">
                    <h2>Media Library</h2>
                    <div id="lib-breadcrumbs"
                        style="flex:1; margin-left:20px; font-family:monospace; color:#aaa; display:flex; align-items:center;">
                        <!-- JS will populate -->
                    </div>
                    {% if is_admin %}
                    <button class="btn-primary" onclick="openUploadModal()">+ Upload Media</button>
                    {% endif %}
                </div>

                <div class="library-controls">
                    <button class="filter-btn active" onclick="filterLibrary('all')">All Library</button>
                    <button class="filter-btn" onclick="filterLibrary('Music')">Music</button>
                    <button class="filter-btn" onclick="filterLibrary('Sermon')">Sermons</button>
                    <button class="filter-btn" onclick="filterLibrary('Announcement')">Announcements</button>
                </div>

                <div class="library-grid" id="library-list">
                    <!-- Items injected here -->
                </div>
            </div>

            <!-- VIEW: SCHEDULE -->
            <div id="schedule-view" class="view">
                <div class="view-header">
                    <h2>Broadcast Schedule</h2>
                </div>
                <!-- Simple list of scheduled events -->
                <div class="schedule-list" id="schedule-list">
                    <!-- Items injected here -->
                </div>
            </div>

            <!-- VIEW: STATS (Admin Only) -->
            {% if is_admin %}
            <div id="stats-view" class="view">
                <div class="view-header">
                    <h2>Listener Trends (Last 90 Days)</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-primary" onclick="fetchStats()">Refresh Data</button>
                        <button class="btn-card" style="background:#ff4444; color:white; border:none;"
                            onclick="clearStats()">Clear Data</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table class="stats-table">
                        <thead>
                            <tr sorted-init="true">
                                <th onclick="fetchStats('title')">Title</th>
                                <th onclick="fetchStats('category')">Category</th>
                                <th onclick="fetchStats('stars_5')">5â˜…</th>
                                <th onclick="fetchStats('stars_4')">4â˜…</th>
                                <th onclick="fetchStats('stars_3')">3â˜…</th>
                                <th onclick="fetchStats('stars_2')">2â˜…</th>
                                <th onclick="fetchStats('stars_1')">1â˜…</th>
                                <th onclick="fetchStats('votes')">Total</th>
                                <th onclick="fetchStats('average')">Avg</th>
                            </tr>
                        </thead>
                        <tbody id="stats-list">
                            <!-- Injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

        </main>
    </div>

    <!-- MODAL: UPLOAD -->
    {% if is_admin %}
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <h2>Upload Media</h2>
            <form id="upload-form">
                <div class="form-group">
                    <label>File(s)</label>
                    <input type="file" name="file" required accept="audio/*,video/*" multiple>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select name="category">
                        <option value="Music">Music</option>
                        <option value="Sermon">Sermon</option>
                        <option value="Announcement">Announcement</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Upload</button>
            </form>
        </div>
    </div>

    <!-- MODAL: SCHEDULE -->
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeScheduleModal()">&times;</span>
            <h2>Schedule Broadcast</h2>
            <p>Select a time for: <b id="schedule-item-title"></b></p>
            <form id="schedule-form">
                <input type="hidden" id="schedule-media-id">
                <div class="form-group">
                    <label>Run At</label>
                    <input type="datetime-local" id="schedule-time" required>
                </div>
                <button type="submit" class="btn-primary">Set Schedule</button>
            </form>
        </div>
    </div>

    <!-- MODAL: YOUTUBE -->
    <div id="youtube-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeYoutubeModal()">&times;</span>
            <h2>Import from YouTube</h2>
            <p>Will be added to "Temporary" category and auto-deleted 24h after play.</p>
            <form id="youtube-form">
                <div class="form-group">
                    <label>Video URL</label>
                    <input type="text" id="yt-url" required placeholder="https://youtube.com/watch?v=...">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="yt-category" class="form-control"
                        style="width:100%; padding:10px; margin-top:5px; background:#222; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="Music" selected>Music</option>
                        <option value="Sermon">Sermon</option>
                        <option value="Announcement">Announcement</option>
                        <option value="Temporary">Temporary</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Import Audio</button>
            </form>
            <hr style="margin:20px 0; border:0; border-top:1px solid #333;">
            <p style="font-size:0.8rem; color:#888;">Auth Error? Upload cookies.txt (Netscape format)</p>
            <form id="cookies-form">
                <input type="file" name="file" required>
                <button type="submit" class="btn-card" style="margin-top:5px;">Update Cookies</button>
            </form>

            <hr style="margin:20px 0; border:0; border-top:1px solid #333;">
            <p style="font-size:0.8rem; color:#ff4444;">Troubleshooting</p>
            <button class="btn-card" style="border:1px solid red; color:red;" onclick="forceReset()">Force Next Track
                (Repair)</button>
        </div>
    </div>

    <!-- MODAL: EDIT -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Track</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="edit-title" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="edit-category" class="form-control"
                        style="width:100%; padding:10px; margin-top:5px; background:#222; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="Music">Music</option>
                        <option value="Sermon">Sermon</option>
                        <option value="Announcement">Announcement</option>
                        <option value="Temporary">Temporary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Folder / Artist (Optional)</label>
                    <input type="text" id="edit-folder" list="folder-datalist"
                        placeholder="Select or type new folder...">
                    <datalist id="folder-datalist"></datalist>
                    <small style="color:#666; display:block; margin-top:5px;">Moves file to subfolder. Leave empty for
                        root.</small>
                </div>
                <div class="form-group">
                    <label>Album Art (Optional)</label>
                    <input type="file" id="edit-art" accept="image/*"
                        style="background:#222; border:1px solid #444; padding:5px; width:100%;">
                    <div id="current-art-preview" style="margin-top:5px;"></div>
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        // Server-side flag
        var IS_ADMIN = {{ 'true' if is_admin else 'false' }};
    </script>
    <script src="/static/js/main.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW fail', err));
            });
        }
    </script>
</body>

</html>